@Master['shared/layout.html'];


@Section['content']

    <div class="text-center row">
        <div class="col-md-6">
            @Each.LeftColumn
            @Current.module_js
            @EndEach

        </div>
        <div class="col-md-6">

            @Each.RightColumn
            <p>test</p>
            @EndEach

            <button type="button" id="editAdmin" class="pull-down btn btn-primary" data-toggle="modal" data-target="#adminEditor">
                Edit dashboard
            </button>
        </div>
    </div>

<div class="modal fade" id="adminEditor" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Editor</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="text-center row">
                    <div class="col-md-6">
              <ul class="list-group" id="editorLeft"></ul>
                    </div>
                    <div  class="col-md-6">
<ul class="list-group" class="editorRight" id="editorRight"></ul>
                    </div>
                </div>
                <script>
                    let mods = [];
                   http.get("/admin/modules/all/", function (modules, status) {
                        if (status === 200){
                      
                            for (let i = 0; i < modules.length; i++){
                                let module = modules[i];
                                if (module.module_active) {
                                    if (module.module_pos === 1) {

                                        $("#editorRight").append(`<li class="list-group-item" id="elem${module.module_id}">${module.module_name} <button class="ml-2 btn btn-outline-danger" onclick="removeElm(${module.module_id})">X</button></li>`);
                                    } else {


                                        $("#editorLeft").append(`<li class="list-group-item" id="elem${module.module_id}">${module.module_name} <button class="ml-2 btn btn-outline-danger" onclick="removeElm(${module.module_id})">X</button></li>`);
                                    }
                                    $("#editorAddDrp").append(`<button class="dropdown-item" id="addList${module.module_id}" onclick="addItem(${module.module_id})" type="button">${module.module_name}</button>`);
                                    
                                }
                        
                            }
                            mods = modules;
                            if (modules.length < 2) {
                                $("#editorAddBtn").hide();
                            }
                            $("#editorRight").sortable();
                            $("#editorLeft").sortable();
                            $("#editorLeft").sortable().bind('sortupdate', function() {
                                updateOrder();
                            });
                            $("#editorRight").sortable().bind('sortupdate', function() {
                                updateOrder();
                            });
                      
                        } 
                    });
                    function addItem(id) {
                        let module = getModule(id);
                        module.module_active = true;
                        if (module.module_id === id){
                            if (module.module_pos === 1){
                                $("#editorRight").append(`<li class="list-group-item" id="elem${module.module_id}">${module.module_name} <button class="ml-2 btn btn-outline-danger" onclick="removeElm(${module.module_id})">X</button></li>`);
                            }else{
                                $("#editorLeft").append(`<li class="list-group-item" id="elem${module.module_id}">${module.module_name} <button class="ml-2 btn btn-outline-danger" onclick="removeElm(${module.module_id})">X</button></li>`);
                            }
                        }
                        $("#addList" + id).remove();
                        mods.push(module);
                        
                    }
                    function removeElm(id) {
                        let module = getModule(id);
             

                        module.module_active = false;
                        $("#editorAddDrp").append(`<button class="dropdown-item" id="addList${module.module_id}" onclick="addItem(${module.module_id})" type="button">${module.module_name}</button>`);
                        $("#elem" + id).remove();
                        modules.pop(module);
                  
                    }
                    function getModule(id) {
                        for (let i = 0; i < mods.length; i++){
                            let m = mods[i];
                            if(m.module_id === id){
                                return m;
                            }
                        } 
                    }
                    function updateOrder() {
                        let activeMods = [];
                        let y = 0;
                        $("#editorRight").each(function (i, obj) {
                            let m = getModule(obj.attr("id"));
                            m.module_pos = 1;
                            m.module_lat = y;
                            y++;
                            activeMods.push(m);
                        });
                        y = 0;
                        $("#editorLeft").each(function (i, obj) {
                            let m = getModule(obj.attr("id"));
                            m.module_pos = 0;
                            m.module_lat = y;
                            y++;
                            activeMods.push(m);
                        });
                        mods = activeMods;
                    }
                    function save() {
                    
                        http.post("/admin/modules/createoredit", mods, function (data, status) {
                            location.reload();
                        });
                    }
                </script>
            </div>
            <div class="modal-footer">
               
                <div  class="dropdown">
                    <button id="editorAddBtn" aria-invalid="editorAdd" class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Add item
                    </button>
                    <div class="dropdown-menu" id="editorAddDrp" aria-labelledby="dropdownMenu2">
         
                    </div>
                </div>
                <button type="button" onclick="save()" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>
@EndSection